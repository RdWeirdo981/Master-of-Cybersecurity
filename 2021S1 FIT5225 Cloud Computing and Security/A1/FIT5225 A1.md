# FIT5225 A1

## Create instance

1) Key: xx-A1

2) Security group: add IPv4 TCP 8080 0.0.0.0/0

3) Upload: files

## Install package

1) install pip3

```
$ sudo apt update
$ sudo apt install python3-pip
$ pip3 --version
```

2) install numpy

```
$ pip3 install numpy
```

3) install opencv

```
$ pip3 install --upgrade pip setuptools wheel
$ pip3 install opencv-python
$ sudo apt update
$ sudo apt install libgl1-mesa-glx
```

4) install flask

```
$ pip3 install Flask
```

## The web service

1) Run server.py

2) Send requests by client.py

3) Success!

## Dockerfile

1) Give the user the permission

```
$ sudo usermod -aG docker ${USER}
```

and re-connect.

2) Go to folder containing **server.py, dockerfile, requirements.txt, and yolo_tiny_configs folder.**

3) Encapsulate 

```
$ docker build -t server_app .
```

4) Run the docker image in a container

```
$ docker run -i -t -p 5000:5000 --name my_server server_app
```

5) Test by run the client.py

6) Success!

### publish the docker image

1) Create an account & login

2) Create a repo

3) Login on the VM:

```
$ docker login --username=[your un] --password=[your pw]
```

4) tag the image:

```
$ docker images
$ docker tag fdfd0ebb119f [username]/app:v1
```

5) push image:

```
$ docker push [username]/app
```

### 

## Kubernetes Cluster

### install kubectl

cmd:

```
$ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
$ sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
$ kubectl version --client
```

### install Kind

cmd:

```
$ curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64
$ chmod +x ./kind
$ sudo mv ./kind /usr/local/bin/kind
$ kind
```

### create a Kuber cluster

1 Kuber cluster --> 1 controller + 1 worker

1) create a cluster: 1 controller + 1 worker 

go to the folder.

```
$ kind create cluster --config kind_setup_config.yml
$ kubectl cluster-info --context kind-kind
$ kubectl get nodes
```

*Note:

--name: can't be capital letter.

container port.

info:

```
Kubernetes control plane is running at https://127.0.0.1:36549
KubeDNS is running at https://127.0.0.1:36549/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

2) delete a cluster

you have to stop and delete all the containers 

```
$ kind delete cluster (--name )
$ sudo swapon --show
```



## Kubernetes Service

### deployment

1) write deployment.yml, transfer it to the local path

2) launch deployment

```
$ kubectl apply -f deployment.yml
$ kubectl describe pod   # see what's wrong
$ kubectl scale deployment iweb-deployment --replicas=4  // change # of pods
```

3) check the current Kuber:

```
$ kubectl get nodes,deployments,pods
```

*Note:

notice the docker hub path.

change replicas to change # of pods

### service

1) write service.yml

2) launch service

```
$ kubectl apply -f service.yml
```

3) get info of service

```
$ kubectl get svc -o wide
```

4) test

```
$ curl http://hostip:80
```

## Experiement

Note:

swapfile is full:

```
$ df -Th
$ df -i
$ sudo swapon --show
```

https://www.linuxidc.com/Linux/2019-07/159580.htm

https://www.chengxuzhilu.com/1304.html

